package Legion
import org.scalatest._ 

import Enkidu.{WorkerPool, Mux, Connection, Listener}
import Legion.Epidemic._ 

import io.netty.channel.socket.nio.{NioSocketChannel,  NioServerSocketChannel}
import io.netty.channel.{Channel, ChannelInitializer}

import bloomfilter.mutable.BloomFilter
import Gossip.Messages._
import com.twitter.util.RandomSocket

import Legion.PeerService.{Client, Server}
import Enkidu.Mux._


object Server extends App {

  val pool = WorkerPool.default

  val clientInitializer = new ChannelInitializer[Channel] {
    def initChannel(c: Channel) = {
      Mux.Pipelines.clientPipeline(c.pipeline)
    }
  }



  val bootstrap = Connection.bootstrap(
    classOf[NioSocketChannel],
    clientInitializer,
    pool 
  )


  val sampler = new Sampler(bootstrap)

  val config = Config(sampler, 3, 6, BloomFilter[String](1000, .001) )
  val D = new Disseminator(config)



  val lhost = "127.0.0.1"

  def nextPeer = Addr.make(lhost, RandomSocket.nextPort)
  val peers = List.fill(5)(nextPeer)

  val views = peers.map {p =>
    PeerView(p)
  }

  val bootstrap_peer = peers.head 
  val servers = views.map {x => new Server(x, D) }

  def makeListener = {
    new Listener[RMSG, TMSG](Mux.Pipelines.serverPipeline, pool, classOf[NioServerSocketChannel] )
  }




  val boot = bs.start(makeListener)

  boot onSuccess { x =>

    rest map { srv =>
      srv.bootstrap(bootstrap_peer, makeListener)
    }
  }


  Await.result(boot) 

}


